#!/bin/bash
# iPad Remote - Desktop launcher
# Starts UxPlay and the BLE HID service

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# PIDs for cleanup
UXPLAY_PID=""
HID_PID=""

cleanup() {
    echo "Shutting down iPad Remote..."

    # Kill HID service
    if [ -n "$HID_PID" ] && kill -0 "$HID_PID" 2>/dev/null; then
        kill "$HID_PID" 2>/dev/null || true
        wait "$HID_PID" 2>/dev/null || true
    fi

    # Kill UxPlay
    if [ -n "$UXPLAY_PID" ] && kill -0 "$UXPLAY_PID" 2>/dev/null; then
        kill "$UXPLAY_PID" 2>/dev/null || true
        wait "$UXPLAY_PID" 2>/dev/null || true
    fi

    exit 0
}

trap cleanup SIGINT SIGTERM EXIT

# Start UxPlay
uxplay -n "iPad Remote Display" -nc &
UXPLAY_PID=$!

sleep 1

if ! kill -0 "$UXPLAY_PID" 2>/dev/null; then
    echo "ERROR: Failed to start UxPlay"
    exit 1
fi

# Start HID service (needs root for Bluetooth)
source "$SCRIPT_DIR/venv/bin/activate"
python3 "$SCRIPT_DIR/main.py" &
HID_PID=$!

# Wait for HID service to exit (it's the main process)
wait "$HID_PID" 2>/dev/null || true
